<!doctype html><head><script src="../eveal.js/eveal.js"></script></head><body>
# Deriver Speedups
## Tracey Jaquith
### Internet Archive ğŸ›ï¸
#### Apr 2, 2021

---
## What is "Deriver"?
A script that creates user accessible files from uploaded files.

<p class="fragment fade-up">
Uses file modify times - skips remaking if "new enough".
</p>

<p class="fragment fade-up">
A dest format can rank preferences of multiple sources.
</p>

<p class="fragment fade-up">
A deriver "module" creates a file from another file<br>
eg: `.mov` => `.mp4`
</p>

---
## Deriver before 2020
Deriver process and all modules:
- used to be only PHP
- required `petabox` tree write privs
- some testing challenges

---
## Serverless Deriving
- Modules can now be docker containers
- Container code can be Python3, JS, Go ..
- Simplified responsibilities

---
## Serverless Deriving
Container "wakes up"
- with full r/w item copy
- simple JSON instructions
  - `sourceFile`
  - `targetFile`
- do your processing
  - exit clean -- files sync back to item
  - exit fail -- derive stops and "red rows" task

---
## Serverless Derivers ğŸ§‘ğŸ½â€ğŸš€
Module authors have own code repo
- with own CI/CD pipelines
- their own tests
- their own branches
- can re/deploy at will

---
## 2021 Deriving
About half of all modules are now serverless

ğŸš€


---
## mp4 fasterer
- upgrade two pass (ideal pre-smartphone)
- to single pass capped Constant Rate Factor
- mp4 deriving 2x as fast


---
## GPU groundwork ğŸ§¦
- switched docker deriving to _`docker.sock`_
  <p class="fragment fade-up">
  - container can now talk to docker server
  </p>
- now mp4 docker container ..
<p class="fragment fade-up">
  - can _create_ a ffmpeg GPU container
</p>
<p class="fragment fade-up">
  - which, by the way, was _already running_ in an overall derive container
</p>

<p class="fragment fade-up">
3 levels deep -- "I can do this all day" ğŸ›¡ï¸
</p>

---
## what is docker.sock like?

---
<!-- .slide: data-background="https://media.giphy.com/media/11CGJUWW1TqnHW/source.gif" -->


---
## TV mp4 deriving
- GPU - NVidia Tesla T4
- transcode up to 900 fps
- that's 30 TV streams (30fps)
  - 24x7
  - "I can do this all day"
    - "Yeah, I know. I know."
- up to 100x faster


---
## GPU - the tricky bits
- proprietary mp4 encoder
- get deinterlacer to work
  <p class="fragment fade-up">
  - convert split frame videos (TV) to single frames (film)<br>
  - YADIF - ideal
  </p>
- GPU-based rescaler
  <p class="fragment fade-up">
  - anamorphic videos<br>
  - "rectangular pixels"
  </p>


---
## GPU
- rebuilt ffmpeg
  - audio/video swiss army knife
- nvidia cuda drivers
- ubuntu/debian

---
## Future speedups
- User uploads needing `.mp4` to GPU
- TV caption alignment to GPU
- TV h.264 video track "pass through"
  - all HD TV is (nearly) "born web ready"
  - 5 SD channels excepted


---
## Thanks! ğŸ™
- hank
- merlijn
- andy, trevor, jonah
- Cobra Commander of Facebook Video Special Forces
- brewster
